<project name="${JOB_NAME}" default="all">
  <property environment="env"/>
  <property name="SOURCE_ROOT" value="${env.WORKSPACE}/${SCM_PATH_MODIFIER}" />
  <property name="BUILD_ROOT" value="${SOURCE_ROOT}/build/ci/build-ci" />

  <condition property="platform" value="windows"><os family="windows" /></condition>
  <condition property="platform" value="unix"><os family="unix" /></condition>

  <taskdef name="cmake" classname="org.iainhull.ant.CmakeBuilder">
  	<classpath>
  		<pathelement location="${SOURCE_ROOT}/non-dist/ant/lib/cmakeant.jar" />
  	</classpath>
  </taskdef>
  <taskdef resource="net/sf/antcontrib/antcontrib.properties">
  	<classpath>
  		<pathelement location="${SOURCE_ROOT}/non-dist/ant/lib/ant-contrib-1.0b3.jar" />
  	</classpath>
  </taskdef>
  
  <target name="all" depends="hourly" />
  <target name="hourly" depends="clean,build,test,run" />

  <target name="clean">
    <delete dir="${BUILD_ROOT}" />
    <delete dir="${BUILD_ROOT}-dbg" />
  </target>

  <target name="cmake">
    <cmake srcdir="${SOURCE_ROOT}" bindir="${bindir}" buildtype="${buildtype}">
      <generator name="Visual Studio 8 2005" platform="windows" />
      <generator name="Unix Makefiles" />
    </cmake>
  </target>

  <target name="build" depends="BuildDebug,BuildRelease" />
  <target name="BuildDebug">
    <if><equals arg1="${platform}" arg2="windows" /><then>
    	<var name="bindir" value="${BUILD_ROOT}" /></then>
    <else>
    	<var name="bindir" value="${BUILD_ROOT}-dbg" /></else>
    </if>
    <antcall target="cmake">
      <param name="buildtype" value="Debug" />
    </antcall>
  </target>
  <target name="BuildRelease">
    <var name="bindir" value="${BUILD_ROOT}" />
    <antcall target="cmake">
      <param name="buildtype" value="Release" />
    </antcall>
  </target>

  <target name="run" depends="RunDebug,RunRelease,RunJava" /> 
  <target name="RunDebug" depends="BuildDebug">
    <if><equals arg1="${platform}" arg2="windows" /><then>
    	<var name="artifacts" value="${BUILD_ROOT}/artifacts/debug" /></then>
    <else>
    	<var name="artifacts" value="${BUILD_ROOT}-dbg/artifacts" /></else>
    </if>
    <exec executable="${artifacts}/hello_d.exe" failonerror="true" />
  </target>
  <target name="RunRelease" depends="BuildRelease">
    <if><equals arg1="${platform}" arg2="windows" /><then>
    	<var name="artifacts" value="${BUILD_ROOT}/artifacts/release" /></then>
    <else>
    	<var name="artifacts" value="${BUILD_ROOT}/artifacts" /></else>
    </if>
    <exec executable="${artifacts}/hello.exe" failonerror="true" />
  </target>
  <target name="RunJava" depends="BuildRelease">
    <echo message="cp=${BUILD_ROOT}/artifacts/hello-java.jar" />
    <java classpath="${BUILD_ROOT}/artifacts/hello-java.jar" classname="net.cryp7.range.hello.Hello" failonerror="true" />
  </target>
  
  <target name="test" depends="TestDebug,TestRelease" />
  <target name="TestDebug" depends="BuildDebug">
    <if><equals arg1="${platform}" arg2="windows" /><then>
    	<var name="artifacts" value="${BUILD_ROOT}/artifacts/debug" /></then>
    <else>
    	<var name="artifacts" value="${BUILD_ROOT}-dbg/artifacts" /></else>
    </if>
    <exec executable="${artifacts}/hello-unittests_d.exe" failonerror="true" />
  </target>
  <target name="TestRelease" depends="BuildRelease">
    <if><equals arg1="${platform}" arg2="windows" /><then>
    	<var name="artifacts" value="${BUILD_ROOT}/artifacts/release" /></then>
    <else>
    	<var name="artifacts" value="${BUILD_ROOT}/artifacts" /></else>
    </if>
    <exec executable="${artifacts}/hello-unittests.exe" failonerror="true" />
  </target>

</project>

<!-- e0f -->
